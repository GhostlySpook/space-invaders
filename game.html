<canvas id="gameCanvas" width="800" height="600"></canvas>
<button id="startButton" onClick="restartGame()">Restart Game</button>
<script>
    //Define canvas
    var gameCanvas = document.getElementById("gameCanvas");
    var ctx = gameCanvas.getContext("2d");
    
    //Load images
    var imgAlien = new Image();
    //imgAlien.src = "http://s3.amazonaws.com/gt7sp-prod/decal/76/67/97/4621335403474976776_1.png";
    imgAlien.src = "Invader.png";

    var imgDefender = new Image();
    //imgDefender.src = "https://pixelartmaker-data-78746291193.nyc3.digitaloceanspaces.com/image/e4af22756166f44.png";
    imgDefender.src = "Defender.png";

    var imgProjectile = new Image();
    imgProjectile.src = "Bullet.png";

    var imgEnemyProjectile = new Image();
    imgEnemyProjectile.src = "EnemyProjectile.png";

    var imgUFO = new Image();
    imgUFO.src = "UFO.png";

    var imgShield = new Image();
    imgShield.src = "Shield.png";

    //////////////////////////////////
    //Game parameters
    //var gameStarted = 0;

    var defaultLives = 3;
    var defaultHighscore = 1000;
    
    //Player settings
    var playerSpeed = 4;
    var playerInitialPosX = 385;
    var playerInitialPosY = 530;
    var playerLimitXLeft = 50;
    var playerLimitXRight = 750;

    var playerHeight = 20;
    var playerWidth = 40;

    var playerProjectileHeight = 20;
    var playerProjectileWidth = 2;
    var maxPlayerProjectiles = 1;
    var playerProjectileSpeed = 10;
    var playerProjectileYLimit = 50;

    //Alien settings
    var alienRows = 5;
    var alienColumns = 11;

    var alienHeight = 20;
    var alienWidth = 40;
    var alienDirection = 1;
    var alienXMoveDistance = 10;
    var alienYMoveDistance = 10;
    var alienDefaultFPSForMovement = 60;
    var alienDefaultFPSForProjectile = 120;

    var alienXLimitLeft = 50;
    var alienXLimitRight = 750;
    var alienXSeparation = 10;
    var alienYSeparation = 15;
    var alienYStart = 100;

    var alienPoints = 10;

    //UFO settings
    var UFOSpeed = 10;

    var UFOPoints = 50;

    //Enemy projectile settings
    var enemyProjectileSpeed = 5;
    var enemyProjectileChance = 1;
    var enemyMaxProjectiles = 5;

    var enemyProjectileHeight = 20;
    var enemyProjectileWidth = 8;

    //Shield settings
    var defaultShields = 4;
    var defaultShieldHealth = 5;
    var defaultShieldWidth = 90;
    var defaultShieldHeight = 40;
    var defaultShieldPosY = 450;
    //End of parameters

    //Start loop
    var gameInterval;

    var fractions = 60;
    var timeFraction = 1000 / fractions;

    var screenWidth = 800;
    var screenHeight = 600;

    var score = 0;
    var highScore = defaultHighscore;
    
    var lives = defaultLives;
    var playerPosX = playerInitialPosX;
    var playerPosY = playerInitialPosY;
    var playerProjectileList = [];

    var keyLeft = false;
    var keyRight = false;
    var keyShoot = false;

    var alienList = [];
    var alienX = 0;
    var alienY = alienYStart;
    var alienMovementFPS = 0;
    let alienChangeDirection = false;
    var bottomAliens = [];

    var enemyProjectileList = [];
    var alienProjectileFPS = 0;

    var UFO = null;

    var shieldList = [];

    var gameLoop = () => {
        ctx.fillStyle = "black";
        ctx.fillRect(0, 0, gameCanvas.width, gameCanvas.height);
        
        //Draw score
        ctx.font = "30px Arial";
        ctx.fillStyle = "#ffffff";
        txtScore = "Score: " + score;
        ctx.fillText(txtScore, 10, 30);

        txtHighscore = "Hi-Score: " + highScore;
        ctx.fillText(txtHighscore, 300, 30);

        //Draw aliens
        let alienLength = alienList.length;
        for(let alienNo = 0; alienNo < alienLength; alienNo++){
            //console.log("Gone through alien no: ", alienNo);
            let currentAlien = alienList[alienNo];
            //console.log(currentAlien);
            ctx.drawImage(imgAlien, currentAlien.posX, currentAlien.posY, currentAlien.width, currentAlien.height);
        }

        //Draw UFO
        //TODO

        //Draw shields
        let shieldLength = shieldList.length;
        for(let shieldNo = 0; shieldNo < shieldLength; shieldNo++){
            let currentShield = shieldList[shieldNo];
            ctx.drawImage(imgShield, currentShield.posX, currentShield.posY, currentShield.width, currentShield.height);
        }

        //Draw player
        ctx.drawImage(imgDefender, playerPosX, playerPosY, playerWidth, playerHeight);

        //Draw friendly projectiles
        let listLength = playerProjectileList.length;
        for(let i = 0; i < listLength; i++){
            let current = playerProjectileList[i];
            ctx.drawImage(imgProjectile, current.posX, current.posY, current.width, current.height);
        }

        //Draw enemy projectiles
        listLength = enemyProjectileList.length;
        for(let i = 0; i < listLength; i++){
            let current = enemyProjectileList[i];
            ctx.drawImage(imgEnemyProjectile, current.posX, current.posY, current.width, current.height);
        }

        //Draw lives
        ctx.font = "20px Arial";
        ctx.fillText(lives, 10, 590);
        let initialXDrawingPos = 50;
        for(let i = 1; i < lives; i++){
            ctx.drawImage(imgDefender, (35*i), 575, 30, 15)
        }
        ctx.fillStyle = "#00FF00"
        ctx.fillRect(0, 565, 800, 3);

        //Check input and handle it
        if(keyLeft == true){
            if((playerPosX - playerSpeed) >= playerLimitXLeft){
                playerPosX -= playerSpeed;
            }
        }
        if(keyRight == true){
            if((playerPosX + playerWidth + playerSpeed) <= playerLimitXRight){
                playerPosX += playerSpeed;
            }
        }
        if(keyShoot == true){
            if(playerProjectileList.length < maxPlayerProjectiles && shotInputReleased == true){
                //Shoot projectile
                //Center projectile based on player
                let centerPlayerX = playerPosX + (playerWidth / 2);
                let projectileX = centerPlayerX - (playerProjectileWidth / 2);

                let projectile = {
                    posX: projectileX,
                    posY: playerPosY,
                    width: playerProjectileWidth,
                    height: playerProjectileHeight 
                };

                playerProjectileList.push(projectile);
            }
            shotInputReleased = false;
        }
        else if(keyShoot == false){
            shotInputReleased = true;
        }



        //Move aliens
        if(alienDefaultFPSForMovement <= alienMovementFPS){
            listLength = alienList.length;

            if(alienChangeDirection){
                alienDirection *= -1;

                for(let alienNo = 0; alienNo < listLength; alienNo++){
                    alienList[alienNo].posY += alienYMoveDistance;
                }

                alienChangeDirection = false;
            }
            
            for(let alienNo = 0; alienNo < listLength; alienNo++){
                alienList[alienNo].posX += alienDirection * alienXMoveDistance;

                if(alienList[alienNo].posX + alienList[alienNo].width > alienXLimitRight || alienList[alienNo].posX < alienXLimitLeft){
                    alienChangeDirection = true;
                }
            }

            alienMovementFPS = 0;
        }
        else{
            alienMovementFPS++;
        }

        //Create enemy projectiles
        //TODO
        if(alienDefaultFPSForProjectile <= alienProjectileFPS){
            listLength = alienList.length;

            //Select a random alien from the bottom and shoot
            //TODO
            let randomAlien = bottomAliens[Math.floor(Math.random() * bottomAliens.length)];

            let projectileX = randomAlien.posX + (randomAlien.width / 2);

            let enemyProjectile = {
                posX: projectileX,
                posY: (randomAlien.posY + randomAlien.height),
                width: enemyProjectileWidth,
                height: enemyProjectileHeight
            };
            enemyProjectileList.push(enemyProjectile);

            alienProjectileFPS = 0;
            console.log("Created enemy projectile");
        }
        else{
            alienProjectileFPS++;
        }
        
        //Move friendly projectile
        let playerProjectileListLength = playerProjectileList.length;
        for(let i = 0; i < playerProjectileListLength; i++){
            let currentProjectile = playerProjectileList[i];
            currentProjectile.posY -= playerProjectileSpeed;
        }

        //Move enemy projectile
        let enemyProjectileLength = enemyProjectileList.length;
        for(let i = 0; i < enemyProjectileLength; i++){
            let currentProjectile = enemyProjectileList[i];
            currentProjectile.posY += enemyProjectileSpeed;
        }

        //Check collision on player projectile
        for(let projectileNo = 0; projectileNo < playerProjectileList.length; projectileNo++){
            let removeProjectile = false;

            let currentProjectile = playerProjectileList[projectileNo];

            //Check if projectile hits shield

            for(let shieldNo = 0; shieldNo < shieldList.length; shieldNo++){
                let currentShield = shieldList[shieldNo];

                if(checkCollision(currentProjectile.posX, currentProjectile.width, 
                currentProjectile.posY, currentProjectile.height, 
                currentShield.posX, currentShield.width, 
                currentShield.posY, currentShield.height)){
                        currentShield.health--;

                        if(currentShield.health <= 0){
                            shieldList.splice(shieldNo, 1);
                            //Creo que no se ocupa al ser destruido el proyectil
                            //shieldNo--;
                        }

                        removeProjectile = true;
                        break;
                }

            }

            if(removeProjectile){
                playerProjectileList.splice(projectileNo, 1);
                projectileNo--;
                continue;
            }

            //Check if projectile hits alien
            for(let alienNo = 0; alienNo < alienList.length; alienNo++){
                let currentAlien = alienList[alienNo];

                if(checkCollision(currentProjectile.posX, currentProjectile.width, 
                currentProjectile.posY, currentProjectile.height, 
                currentAlien.posX, currentAlien.width, 
                currentAlien.posY, currentAlien.height)){

                        let currentColumn = currentAlien.column;
                        let currentRow = currentAlien.row;
                        alienList.splice(alienNo, 1);
                        removeProjectile = true;

                        //Update aliens in bottom
                        let lowestAlien = null;
                        for(let i = 0; i < alienList.length; i++){
                            if(currentColumn == alienList[i].column){
                                if(lowestAlien == null){
                                    lowestAlien = alienList[i];
                                }
                                else if(lowestAlien.row < alienList[i].row){
                                    lowestAlien = alienList[i];
                                }
                            }
                        }

                        if(lowestAlien != null){
                            bottomAliens.push(lowestAlien);
                        }
                        
                        bottomAliens = bottomAliens.filter(alien => !(alien.row == currentRow && alien.column == currentColumn));

                        /*if(lowestAlien != null){
                            bottomAliens = bottomAliens.filter(alien => !(alien.row == currentRow && alien.column == currentColumn));
                            bottomAliens.push(lowestAlien);
                        }
                        else{

                        }*/

                        break;
                }
            }

            if(removeProjectile){
                playerProjectileList.splice(projectileNo, 1);
                projectileNo--;
                continue;
            }


            //Check if projectile hits UFO
            //TODO

            if(removeProjectile){
                playerProjectileList.splice(projectileNo, 1);
                projectileNo--;
                continue;
            }

            //Check if projectile hits enemy projectile
            //TODO
            /*for(let enemyProjectileNo = 0; enemyProjectileNo < enemyProjectileList.length; enemyProjectileNo++){
                let currentAlien = enemyProjectileList[enemyProjectileNo];

                if(checkCollision(currentProjectile.posX, currentProjectile.width, 
                currentProjectile.posY, currentProjectile.height, 
                currentAlien.posX, currentAlien.width, 
                currentAlien.posY, currentAlien.height)){

                        alienList.pop(alienNo);
                        removeProjectile = true;
                        break;
                }

            }*/

            //Projectile reaches end of screen
            if(currentProjectile.posY <= playerProjectileYLimit){
                playerProjectileList.splice(projectileNo, 1);
                projectileNo--;
            }

        }

        //Check collision of enemy projectile
        for(let projectileNo = 0; projectileNo < enemyProjectileList.length; projectileNo++){
            let removeProjectile = false;

            let currentProjectile = enemyProjectileList[projectileNo];

            //Check if projectile hits shield

            for(let shieldNo = 0; shieldNo < shieldList.length; shieldNo++){
                let currentShield = shieldList[shieldNo];

                if(checkCollision(currentProjectile.posX, currentProjectile.width, 
                currentProjectile.posY, currentProjectile.height, 
                currentShield.posX, currentShield.width, 
                currentShield.posY, currentShield.height)){
                        currentShield.health--;

                        if(currentShield.health <= 0){
                            shieldList.splice(shieldNo, 1);
                            //Creo que no se ocupa al ser destruido el proyectil
                            //shieldNo--;
                        }

                        removeProjectile = true;
                        break;
                }

            }

            if(removeProjectile){
                enemyProjectileList.splice(projectileNo, 1);
                projectileNo--;
                continue;
            }

            //Check if projectile hits player
            if(checkCollision(currentProjectile.posX, currentProjectile.width,
            currentProjectile.posY, currentProjectile.height,
            playerPosX, playerWidth, playerPosY, playerHeight)){
                //TODO Activate game over check and all that
                lives--;
                removeProjectile = true;
            }

            if(removeProjectile){
                enemyProjectileList.splice(projectileNo, 1);
                projectileNo--;
                continue;
            }

            //Projectile reaches end of screen
            if(currentProjectile.posY >= 550){
                enemyProjectileList.splice(projectileNo, 1);
                projectileNo--;
            }
        }

            //Check if projectile hits player

            //Check if projectile hits shield
    };

    var restartGame = () => {
        //console.log("Restarted");
        
        if(gameInterval != null){
            clearInterval(gameInterval);
        }

        document.removeEventListener('keydown', handleKeyDown);
        document.removeEventListener('keyup', handleKeyUp);
        //gameStarted = 1;

        //Prepare score
        score = 0;

        //Prepare lives
        lives = defaultLives;

        //Add aliens to game
        alienList = [];
        let initialX = 400 - ((alienColumns * alienWidth + alienXSeparation * (alienColumns - 1)) / 2);        
        let initialY = alienYStart;
        let currentY = initialY;

        //Create alien rows
        for(let row = 0; row < alienRows; row++){

            let currentX = initialX;

            for(let column = 0; column < alienColumns; column++){

                let alien = {
                    row: row,
                    column: column,
                    posX: currentX,
                    posY: currentY,
                    width: alienWidth,
                    height: alienHeight
                };

                alienList.push(alien);

                currentX += alienXSeparation + alienWidth;

                if(row == alienRows - 1){
                    bottomAliens.push(alien);
                    console.log(bottomAliens);
                }
            }

            currentY += alienYSeparation + alienHeight;
        }

        //Add player
        playerPosX = playerInitialPosX;
        playerPosY = playerInitialPosY;

        //Add shields
        shieldList = [];
        let currentX = 0;
        //let halfShieldSeparation = defaultShieldWidth / 2;
        let halfShieldSeparation = (800 - defaultShields * defaultShieldWidth) / (defaultShields + 1);
        //console.log(halfShieldSeparation);
        for(let shieldNo = 0; shieldNo < defaultShields; shieldNo++){
            currentX += halfShieldSeparation;

            let shield = {
                width: defaultShieldWidth,
                height: defaultShieldHeight,
                posX: currentX,
                posY: defaultShieldPosY,
                health: defaultShieldHealth
            };

            currentX += defaultShieldWidth;

            shieldList.push(shield);
        }

        gameInterval = setInterval(gameLoop, timeFraction);

        document.addEventListener('keydown', handleKeyDown);
        document.addEventListener('keyup', handleKeyUp);
    }

    var handleKeyDown = () =>{
        if(event.keyCode == 37 && keyLeft == false) {
            keyLeft = true;
            //console.log('Left was pressed');
        }
        else if(event.keyCode == 39 && keyRight == false) {
            keyRight = true;
            //console.log('Right was pressed');
        }
        else if(event.keyCode == 65 && keyShoot == false) {
            keyShoot = true;
            //console.log('A was pressed');
        }
    }

    var handleKeyUp = () => {
        if(event.keyCode == 37 && keyLeft == true) {
            keyLeft = false;
            console.log('Left was released');
        }
        else if(event.keyCode == 39 && keyRight == true) {
            keyRight = false;
            console.log('Right was released');
        }
        else if(event.keyCode == 65 && keyShoot == true) {
            keyShoot = false;
            console.log('A was pressed');
        }
    }

    var checkCollision = (x1, width1, y1, height1, x2, width2, y2, height2) =>{
        return x1 + width1 > x2 && 
            x2 + width2 > x1 && 
            y1 + height1 > y2 &&
            y2 + height2 > y1;
    }

</script>